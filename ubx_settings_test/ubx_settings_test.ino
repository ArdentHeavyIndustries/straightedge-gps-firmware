#include<SoftwareSerial.h>

// MANY OF THESE DID NOT WORK AS INTENDED.

// turn on the GPS in powersave mode.
// blink once per second forever.
// doesn't stop for daytime, doesn't read in the GPS.

// LED controller
#define led 4

// GPS Setup
#define enGPS 1
#define inGPS 2
#define rxGPS 0
#define txGPS 3

SoftwareSerial serialGPS = SoftwareSerial(rxGPS, txGPS) ;
 
// reset GPS to factory settings - UBX-CFG-CFG/clear
//uint8_t resetUBX[] = { 0xB5, 0x62, 0x06, 0x09, 0x0D, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x03, 0x1B, 0x9A } ;

uint8_t resetUBX[] = { 0xB5, 0x62, 0x06, 0x09, 0x0D, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x17, 0x2F, 0xAE } ;

// configure power save mode to be cyclic mode - UBX-CFG-PM2
uint8_t setupPSM[] = { 0xB5, 0x62, 0x06, 0x3B, 0x2C, 0x00, 0x01, 0x06, 0x00, 0x00, 0x00, 0x80, 0x02, 0x01, 0x10, 0x27, 0x00, 0x00, 0x10, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2C, 0x01, 0x00, 0x00, 0x4F, 0xC1, 0x03, 0x00, 0x87, 0x02, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x64, 0x40, 0x01, 0x00, 0xD2, 0xEA } ; 

// turn on power save mode - UBX-CFG-RXM
uint8_t activatePSM[] = { 0xB5, 0x62, 0x06, 0x11, 0x02, 0x00, 0x08, 0x01, 0x22, 0x92 } ;

// set time pulse mode to twice a second
uint8_t timepulseTest[] = { 0xB5, 0x62, 0x06, 0x31, 0x20, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0xA1, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA0, 0x86, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF3, 0x00, 0x00, 0x00, 0x3A, 0xAF } ;

// save this into permanent settings - UBX-CFG-CFG/save (and maybe also need load?)
uint8_t saveCFG[] = { 0xB5, 0x62, 0x06, 0x09, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1D, 0xAB } ;

void setup() {                
  // initialize the digital pin as an output.
  pinMode(led, OUTPUT);     
  pinMode(rxGPS, INPUT);
  pinMode(txGPS, OUTPUT);
  pinMode(enGPS, OUTPUT);
  pinMode(inGPS, INPUT);

  // turn off GPS
  digitalWrite(enGPS, LOW);

  serialGPS.begin(9600);

  delay(1000);

  // turn on GPS
  digitalWrite(enGPS, HIGH);
  sendUBX( resetUBX, 21 );

  /*
  // wait 10 s - should be blinking once a second
  delay(10000);

  setupPowerSaveMode();

  // wait 10 s - should be blinking twice a second
  delay(10000);

  // turn off GPS and turn back on
  digitalWrite(enGPS, LOW);
  delay(1000);
  digitalWrite(enGPS, HIGH);
  */
}

// the loop routine runs over and over again forever:
void loop() {
  // is it blinking twice per second, or once?
}


void setupPowerSaveMode() {
  //  sendUBX( setupPSM, 52 );
  //  sendUBX( activatePSM, 10 );
  sendUBX( timepulseTest, 40 );
  sendUBX( saveCFG, 21 );
}
 

void blinkOnceEveryN( int n ) {
  // blink once every N seconds

  int delayN = ( 1000 * n ) - 40;

  analogWrite(led, 32);  // turn on the LED nice and dim
  delay(40);
  analogWrite(led, 0);  // turn off LED
  delay(delayN);
}
